<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>関数アニメーション</title>
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    canvas { border: 1px solid gray; margin-top: 20px; }
    label, select, input { margin: 10px; font-size: 16px; }
  </style>
</head>
<body>

<h1>関数による入力→出力アニメーション</h1>

<label for="function">関数を選択:</label>
<select id="function">
  <option value="square">x²</option>
  <option value="plus1">x + 1</option>
  <option value="sin">sin(x)</option>
</select>

<label for="inputValue">入力値:</label>
<input type="number" id="inputValue" value="2" step="0.1">

<button id="run">アニメーション開始</button>

<canvas id="canvas" width="800" height="300"></canvas>

<script type="py">
from js import document, requestAnimationFrame, Math
from pyodide.ffi import create_proxy

canvas = document.getElementById("canvas")
ctx = canvas.getContext("2d")

def clear():
    ctx.clearRect(0, 0, canvas.width, canvas.height)

def draw_static(input_value, func_label):
    clear()
    # 入力円
    ctx.beginPath()
    ctx.arc(100, 150, 50, 0, 2*Math.PI)
    ctx.stroke()
    ctx.font = "16px sans-serif"
    ctx.textAlign = "center"
    ctx.fillText(f"入力\n{input_value}", 100, 150)

    # 関数ブロック
    ctx.fillStyle = "#8B3E0D"
    ctx.fillRect(300, 75, 50, 150)
    ctx.fillStyle = "white"
    ctx.save()
    ctx.translate(325, 150)
    ctx.rotate(-Math.PI / 2)
    ctx.fillText("関数\n" + func_label, 0, 5)
    ctx.restore()

    # 出力三角形
    ctx.beginPath()
    ctx.moveTo(550, 100)
    ctx.lineTo(600, 200)
    ctx.lineTo(500, 200)
    ctx.closePath()
    ctx.stroke()
    ctx.fillStyle = "black"
    ctx.fillText("出力", 550, 180)

def animate_point(x_values, y, output_value):
    index = 0
    def step():
        nonlocal index
        if index < len(x_values):
            clear()
            draw_static(current_input, function_label)
            ctx.beginPath()
            ctx.arc(x_values[index], y, 10, 0, 2*Math.PI)
            ctx.fillStyle = "red"
            ctx.fill()
            index += 1
            requestAnimationFrame(create_proxy(step))
        else:
            ctx.fillStyle = "blue"
            ctx.fillText(f"{round(output_value, 2)}", 550, 240)
    step()

def get_function(name):
    if name == "square":
        return lambda x: x ** 2, "x²"
    elif name == "plus1":
        return lambda x: x + 1, "x + 1"
    elif name == "sin":
        return lambda x: Math.sin(x), "sin(x)"
    return lambda x: x, "x"

def on_run(event):
    global current_input, function_label
    func_name = document.getElementById("function").value
    current_input = float(document.getElementById("inputValue").value)
    func, function_label = get_function(func_name)
    output_value = func(current_input)

    # 経路生成
    x_path = list(range(100, 300, 5)) + list(range(350, 550, 5))
    animate_point(x_path, 150, output_value)

document.getElementById("run").addEventListener("click", create_proxy(on_run))
</script>

</body>
</html>
